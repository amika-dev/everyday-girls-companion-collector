@model EverydayGirlsCompanionCollector.Models.ViewModels.CollectionViewModel
@{
    ViewData["Title"] = "Collection";
}

<div class="collection-container">
<!-- Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- Viewing Selector -->
    <div class="eg-viewing-selector mb-4">
        <div class="eg-viewing-label">Viewing</div>
        <div class="eg-viewing-pills">
            <a asp-action="Index" asp-route-sort="bond" asp-route-page="1" 
               class="eg-viewing-pill @(Model.SortMode == "bond" ? "active" : "")">
                Bond
            </a>
            <a asp-action="Index" asp-route-sort="oldest" asp-route-page="1" 
               class="eg-viewing-pill @(Model.SortMode == "oldest" ? "active" : "")">
                Oldest
            </a>
            <a asp-action="Index" asp-route-sort="newest" asp-route-page="1" 
               class="eg-viewing-pill @(Model.SortMode == "newest" ? "active" : "")">
                Newest
            </a>
        </div>
    </div>

    <!-- Collection Grid (2 rows × 5 columns = 10 per page) -->
    @if (Model.Girls.Any())
    {
        <div class="collection-grid">
            @foreach (var girl in Model.Girls)
            {
                <div class="collection-card girl-card @(girl.IsPartner ? "partner-highlight" : "")" 
                     data-girl-id="@girl.GirlId">
                    <img src="@girl.ImageUrl" alt="@girl.Name" class="collection-image girl-image-square eg-portrait-ring--square" />
                    
                    <div class="eg-card-name-area">
                        <h5 class="eg-hero-name" style="font-size: 1.1rem; margin: 0;" title="@girl.Name">@girl.Name</h5>
                    </div>
                    
                    <div class="eg-card-badge-area">
                        <span class="eg-badge--partner @(girl.IsPartner ? "" : "eg-badge--ghost")">Partner</span>
                    </div>

                    <div class="eg-card-stats-area">
                        <span class="eg-card-stat">💖 @girl.Bond</span>
                        <span class="eg-card-stat">@girl.PersonalityTag</span>
                    </div>

                    <div class="eg-card-action-area">
                        <button type="button" class="btn btn-sm btn-info" 
                                data-bs-toggle="modal" data-bs-target="#girlModal"
                                onclick="loadGirlModal(@girl.GirlId, '@girl.Name', '@girl.ImageUrl', @girl.Bond, '@girl.DateMetUtc.ToString("yyyy-MM-dd")', '@girl.PersonalityTag', @girl.IsPartner.ToString().ToLower(), @girl.DaysSinceAdoption)">
                            More About Her
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Gallery Navigation -->
        <div class="eg-gallery-nav">
            @if (Model.CurrentPage > 1)
            {
                <a asp-action="Index" asp-route-sort="@Model.SortMode" asp-route-page="@(Model.CurrentPage - 1)" 
                   class="eg-nav-button eg-nav-prev">
                    <span class="eg-nav-icon">←</span>
                    <span class="eg-nav-label">Earlier Companions</span>
                </a>
            }
            else
            {
                <div class="eg-nav-button eg-nav-disabled">
                    <span class="eg-nav-icon">←</span>
                    <span class="eg-nav-label">Earlier Companions</span>
                </div>
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a asp-action="Index" asp-route-sort="@Model.SortMode" asp-route-page="@(Model.CurrentPage + 1)" 
                   class="eg-nav-button eg-nav-next">
                    <span class="eg-nav-label">More Companions</span>
                    <span class="eg-nav-icon">→</span>
                </a>
            }
            else
            {
                <div class="eg-nav-button eg-nav-disabled">
                    <span class="eg-nav-label">More Companions</span>
                    <span class="eg-nav-icon">→</span>
                </div>
            }
        </div>
    }
    else
    {
        <div class="eg-card eg-card--warm text-center" style="max-width: 500px; margin: 0 auto;">
            <div class="eg-rhythm-sm">
                <div class="eg-subtitle">My Companions</div>
                <p class="text-muted mb-0">Your journey begins when you welcome your first companion home.</p>
            </div>
        </div>
    }

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Return Home</a>
    </div>
</div>

<!-- Girl Modal -->
<div class="modal fade" id="girlModal" tabindex="-1" aria-labelledby="girlModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content eg-card--warm">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body eg-rhythm-lg">
                <!-- Hero Section -->
                <div class="eg-modal-hero-stack">
                    <img id="modalImage" src="" alt="" class="modal-girl-image girl-image-square eg-portrait-ring--square" />
                    <div class="eg-subtitle">TOGETHER WITH</div>
                    <h4 id="modalName" class="eg-hero-name"></h4>
                    <div id="modalPartnerBadge" class="d-none">
                        <span class="eg-badge--partner">Current Partner</span>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="eg-modal-stats">
                    <div class="eg-subtitle text-center mb-3">YOUR TIME TOGETHER</div>
                    <div class="eg-stat-list mx-auto">
                        <div class="eg-stat-row">
                            <span class="eg-stat-label">💖 Bond</span>
                            <span class="eg-stat-value" id="modalBond"></span>
                        </div>
                        <div class="eg-stat-row">
                            <span class="eg-stat-label">📅 First Met</span>
                            <span class="eg-stat-value" id="modalDateMet"></span>
                        </div>
                        <div class="eg-stat-row">
                            <span class="eg-stat-label">🌱 Days Together</span>
                            <span class="eg-stat-value" id="modalDaysTogether"></span>
                        </div>
                        <div class="eg-stat-row">
                            <span class="eg-stat-label">☁️ Personality</span>
                            <span class="eg-stat-value" id="modalTag"></span>
                        </div>
                    </div>
                </div>

                <hr class="eg-modal-divider" />

                <!-- Actions Section -->
                <div class="eg-rhythm-sm">
                    <!-- Set Partner -->
                    <form method="post" asp-action="SetPartner" class="mb-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="girlId" id="modalGirlId" />
                        <input type="hidden" name="returnSort" value="@Model.SortMode" />
                        <input type="hidden" name="returnPage" value="@Model.CurrentPage" />
                        <button type="submit" class="btn btn-primary w-100">Make Her My Partner</button>
                    </form>

                    <!-- Change Personality Tag -->
                    <form method="post" asp-action="SetTag" class="mb-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="girlId" id="modalGirlIdTag" />
                        <input type="hidden" name="returnSort" value="@Model.SortMode" />
                        <input type="hidden" name="returnPage" value="@Model.CurrentPage" />
                        <div class="mb-2">
                            <label for="tagSelect" class="eg-modal-label">How would you describe her?</label>
                            <select name="tag" id="tagSelect" class="form-select" onchange="checkTagChanged()">
                                <option value="0">Cheerful</option>
                                <option value="1">Shy</option>
                                <option value="2">Energetic</option>
                                <option value="3">Calm</option>
                                <option value="4">Playful</option>
                                <option value="5">Tsundere</option>
                                <option value="6">Cool</option>
                                <option value="7">Doting</option>
                                <option value="8">Yandere</option>
                            </select>
                        </div>
                        <button type="submit" id="tagSubmitButton" class="btn btn-secondary w-100" style="display: none;">That Sounds Right</button>
                    </form>

                    <!-- Abandon -->
                    <form method="post" asp-action="Abandon" id="abandonForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="girlId" id="modalGirlIdAbandon" />
                        <input type="hidden" name="returnSort" value="@Model.SortMode" />
                        <input type="hidden" name="returnPage" value="@Model.CurrentPage" />
                        <button type="button" class="btn btn-outline-secondary w-100" id="abandonButton" onclick="confirmAbandonFromModal()">
                            Part Ways
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Dynamically generated personality tag mapping from C# enum
    var personalityTagMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PersonalityTagMap));

    function loadGirlModal(girlId, name, imageUrl, bond, dateMet, tag, isPartner, daysTogether) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalImage').alt = name;
            document.getElementById('modalName').textContent = name;
            document.getElementById('modalBond').textContent = bond;
            document.getElementById('modalDateMet').textContent = dateMet;
            document.getElementById('modalDaysTogether').textContent = daysTogether;
            document.getElementById('modalTag').textContent = tag;
            document.getElementById('modalGirlId').value = girlId;
            document.getElementById('modalGirlIdTag').value = girlId;
            document.getElementById('modalGirlIdAbandon').value = girlId;

            // Show/hide partner badge and disable abandon if partner
            if (isPartner) {
                document.getElementById('modalPartnerBadge').classList.remove('d-none');
                document.getElementById('abandonButton').disabled = true;
            } else {
                document.getElementById('modalPartnerBadge').classList.add('d-none');
                document.getElementById('abandonButton').disabled = false;
            }

            // Set current tag in dropdown using the generated map
            var tagValue = personalityTagMap[tag];
            document.getElementById('tagSelect').value = tagValue;
            document.getElementById('tagSelect').dataset.originalValue = tagValue;
            
            // Hide button initially since no change yet
            document.getElementById('tagSubmitButton').style.display = 'none';
        }
        
        function checkTagChanged() {
            var select = document.getElementById('tagSelect');
            var button = document.getElementById('tagSubmitButton');
            var originalValue = select.dataset.originalValue;
            var currentValue = select.value;
            
            if (originalValue !== currentValue) {
                button.style.display = 'block';
            } else {
                button.style.display = 'none';
            }
        }

        function confirmAbandonFromModal() {
            var name = document.getElementById('modalName').textContent;
            if (confirmAbandon(name)) {
                document.getElementById('abandonForm').submit();
            }
        }
    </script>
}
