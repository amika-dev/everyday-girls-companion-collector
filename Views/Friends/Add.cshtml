@model EverydayGirlsCompanionCollector.Models.PagedResult<EverydayGirlsCompanionCollector.Models.ViewModels.UserSearchResultDto>?
@{
    ViewData["Title"] = "Add Friends";
    var searchQuery = ViewData["SearchQuery"] as string ?? "";
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

<div class="friends-container">

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success text-center">@successMessage</div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger text-center">@errorMessage</div>
    }

    <div class="text-center mb-4">
        <div class="eg-subtitle">Add Friends</div>
    </div>

    <!-- Search form -->
    <div class="eg-card eg-card--warm mb-4">
        <form method="get" asp-controller="Friends" asp-action="Add">
            <label for="q" class="eg-form-label">Search by name</label>
            <div class="friends-search-row">
                <input type="text"
                       class="form-control"
                       id="q"
                       name="q"
                       value="@searchQuery"
                       placeholder="Type a name…"
                       autocomplete="off" />
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
            <small class="eg-hint">Search finds names that start with what you type.</small>
        </form>
    </div>

    <!-- Results -->
    @if (Model != null)
    {
        if (Model.Items.Count == 0)
        {
            <div class="eg-card eg-card--warm friends-empty-state text-center">
                <p class="text-muted mb-0">No one found — try a different name.</p>
            </div>
        }
        else
        {
            <div class="friends-list">
                @foreach (var user in Model.Items)
                {
                    <div class="friend-card">
                        <div class="friend-card-inner">
                            <div class="friend-avatar-area">
                                @if (!string.IsNullOrEmpty(user.PartnerImagePath))
                                {
                                    <img src="@user.PartnerImagePath" alt="@user.DisplayName" class="friend-avatar friend-avatar-image" />
                                }
                                else
                                {
                                    <div class="friend-avatar friend-avatar-letter">
                                        <span>@(user.DisplayName.Length > 0 ? user.DisplayName[0].ToString().ToUpper() : "?")</span>
                                    </div>
                                }
                            </div>
                            <div class="friend-info">
                                <span class="friend-display-name">@user.DisplayName</span>
                            </div>
                            <div class="friend-card-action">
                                @if (user.IsAlreadyFriend)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" disabled>Added</button>
                                }
                                else if (!user.CanAdd)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" disabled>—</button>
                                }
                                else
                                {
                                    <form method="post" asp-controller="Friends" asp-action="Add" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="friendUserId" value="@user.UserId" />
                                        <input type="hidden" name="q" value="@searchQuery" />
                                        <input type="hidden" name="page" value="@(Model?.Page ?? 1)" />
                                        <button type="submit" class="btn btn-sm btn-primary">Add</button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }

    <div class="friend-actions mt-4">
        <a asp-controller="Friends" asp-action="Index" class="btn btn-info btn-lg">Friends List</a>
        <a asp-controller="Profile" asp-action="Index" class="btn btn-outline-secondary btn-lg">Back to Profile</a>
    </div>
</div>
